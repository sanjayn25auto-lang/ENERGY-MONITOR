/* 
  Sketch generated by the Arduino IoT Cloud Thing "energy monitor"
  https://create.arduino.cc/cloud/things/d38ca912-5d3f-467e-a045-daea51f34f61 

  Arduino IoT Cloud Variables description

  The following variables are automatically generated and updated when changes are made to the Thing

  String msg;
  int person;

  Variables which are marked as READ/WRITE in the Cloud Thing will also have functions
  which are called when their values are changed from the Dashboard.
  These functions are generated with the Thing and added at the end of this sketch.
*/

#include "thingProperties.h"

// ================== NEW PIN DEFINE ==================
#define IR_ENTRY 16
#define IR_EXIT  17

#define LED1 25
#define LED2 26
#define LED3 27
#define LED4 14

// state memory for rising edge
int lastEntryState = LOW;
int lastExitState  = LOW;

void setup() {
  Serial.begin(9600);
  delay(1500);

  pinMode(IR_ENTRY, INPUT);
  pinMode(IR_EXIT , INPUT);

  pinMode(LED1, OUTPUT);
  pinMode(LED2, OUTPUT);
  pinMode(LED3, OUTPUT);
  pinMode(LED4, OUTPUT);

  initProperties();
  ArduinoCloud.begin(ArduinoIoTPreferredConnection);
  setDebugMessageLevel(2);
  ArduinoCloud.printDebugInfo();
}

void loop() {
  ArduinoCloud.update();

  // ===================================================
  // --- RISING EDGE ENTRY ---
  int nowEntry = digitalRead(IR_ENTRY);
  if(nowEntry==HIGH && lastEntryState==LOW){
    person++;
  }
  lastEntryState = nowEntry;

  // --- RISING EDGE EXIT ---
  int nowExit = digitalRead(IR_EXIT);
  if(nowExit==HIGH && lastExitState==LOW){
    if(person>0) person--;
  }
  lastExitState = nowExit;
  // ===================================================

  // LED logic (bar graph)
  digitalWrite(LED1, (person>0) );
  digitalWrite(LED2, (person>1) );
  digitalWrite(LED3, (person>2) );
  digitalWrite(LED4, (person>3) );

  if (person==0) msg="ROOM EMPTY";
  else if (person<4) msg="NORMAL";
  else msg="FULL CROWDED";

  Serial.print("person: ");
  Serial.print(person);
  Serial.print("  msg: ");
  Serial.println(msg);
}

/*
  Since Msg is READ_WRITE variable, onMsgChange() is
  executed every time a new value is received from IoT Cloud.
*/
void onMsgChange()  {
}

/*
  Since Person is READ_WRITE variable, onPersonChange() is
  executed every time a new value is received from IoT Cloud.
*/
void onPersonChange()  {
  // cloud -> LED sync
  digitalWrite(LED1, (person>0) );
  digitalWrite(LED2, (person>1) );
  digitalWrite(LED3, (person>2) );
  digitalWrite(LED4, (person>3) );

  if (person==0) msg="ROOM EMPTY";
  else if (person<4) msg="NORMAL";
  else msg="FULL CROWDED";

  Serial.println("Cloud updated PERSON -> LED sync done");
}
